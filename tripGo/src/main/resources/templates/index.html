<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" th:href="@{/assets/favicon.png}">
    <title>TripGo â€“ Book Buses</title>
    <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
    />
</head>
<body class="bg-gray-100">
<!-- HEADER -->
<header class="bg-blue-600 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold">TripGo</h1>

        <!-- Account button -->
        <button
                class="flex items-center space-x-2 focus:outline-none"
                id="openDrawerBtn"
        >
            <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
            >
                <path
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                />
            </svg>
            <span>Account</span>
        </button>
    </div>
</header>

<!-- MAIN -->
<main class="container mx-auto p-6">
    <h2 class="text-3xl font-bold mb-6">Search Buses</h2>
    <form class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input class="p-3 border rounded" placeholder="From" type="text" />
        <input class="p-3 border rounded" placeholder="To" type="text" />
        <input class="p-3 border rounded" type="date" />
        <button class="bg-blue-600 text-white p-3 rounded" type="submit">
            Search
        </button>
    </form>
</main>

<!-- DRAWER -->
<div class="fixed inset-0 z-50 hidden" id="accountDrawer">
    <div
            class="fixed inset-0 bg-black bg-opacity-50"
            id="drawerOverlay"
    ></div>

    <!-- panel -->
    <div
            class="fixed right-0 top-0 h-full w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300"
            id="drawerPanel"
    >
        <div class="flex justify-between items-center p-3 border-b">
            <h2 class="text-lg font-bold">Account</h2>
            <button
                    class="text-gray-500 hover:bg-gray-100 p-2 rounded-3xl"
                    id="closeDrawerBtn"
            >
                <svg class="w-6 h-6" fill="none" stroke="black" viewBox="0 0 24 24">
                    <path
                            d="M6 18L18 6M6 6l12 12"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                    />
                </svg>
            </button>
        </div>

        <div class="space-y-4" id="drawerContent">
            <!-- content filled by JS -->
        </div>
    </div>
</div>

<a
        id="oauthGoogle"
        th:href="@{/oauth2/authorization/google}"
        class="hidden"
></a>
<a
        id="oauthGithub"
        th:href="@{/oauth2/authorization/github}"
        class="hidden  "
></a>

<script>
    const drawer = document.getElementById("accountDrawer");
    const overlay = document.getElementById("drawerOverlay");
    const panel = document.getElementById("drawerPanel");
    const openBtn = document.getElementById("openDrawerBtn");
    const closeBtn = document.getElementById("closeDrawerBtn");
    const content = document.getElementById("drawerContent");

    function openDrawer() {
      drawer.classList.remove("hidden");
      setTimeout(() => panel.classList.remove("translate-x-full"), 10);
    }

    function closeDrawer() {
      panel.classList.add("translate-x-full");
      setTimeout(() => drawer.classList.add("hidden"), 300);
    }

    let isAdmin = false;

    async function checkAdminStatus() {
      const jwt = localStorage.getItem("jwt");
      if (!jwt) return;

      try {
        const res = await fetch("/api/v1/auth/is-admin", {
          headers: { Authorization: `Bearer ${jwt}` },
        });
        if (res.ok) {
          isAdmin = await res.json();
          console.log("User is admin:", isAdmin);
        }
      } catch (err) {
        console.error("Admin check failed:", err);
      }
    }

    console.log(isAdmin);

    function renderDrawer() {
      const jwt = localStorage.getItem("jwt");
      const username = localStorage.getItem("username") || "User";

      if (jwt) {
        content.innerHTML = `
      <div class="text-center py-6">
        <div class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto text-xl font-bold mb-3">
          ${username.charAt(0).toUpperCase()}
        </div>
        <p class="font-medium text-lg">Hi, ${username}</p>

        ${
          isAdmin
            ? `
            <a href="/api/v1/admin1" class="w-full flex justify-left items-center gap-3 hover:bg-gray-100 p-2 border-b border-#b3b3b3 mt-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24">
              <g>
                  <path fill="none" d="M0 0h24v24H0z"/>
                  <path d="M12 14v8H4a8 8 0 0 1 8-8zm0-1c-3.315 0-6-2.685-6-6s2.685-6 6-6 6 2.685 6 6-2.685 6-6 6zm9 4h1v5h-8v-5h1v-1a3 3 0 0 1 6 0v1zm-2 0v-1a1 1 0 0 0-2 0v1h2z"/>
              </g>
              </svg>
                <p class="text-xl font-semibold py-2">
                  Admin Panel
                </p>
            </a>
            `
            : ""
        }
        <button id="logoutBtn" class="w-full flex justify-left items-center gap-3 hover:bg-gray-100 p-3 border-b border-#b3b3b3" >
            <svg xmlns="http://www.w3.org/2000/svg" width="25px" height="25px" viewBox="0 0 24 24" fill="none">
                <path d="M21 12L13 12" stroke="#323232" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18 15L20.913 12.087V12.087C20.961 12.039 20.961 11.961 20.913 11.913V11.913L18 9" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M16 5V4.5V4.5C16 3.67157 15.3284 3 14.5 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H14.5C15.3284 21 16 20.3284 16 19.5V19.5V19" stroke="#323232" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p class="text-xl font-semibold py-2">
          Logout
        </p>
         </button>
      </div>`;

        document.getElementById("logoutBtn").onclick = logout;
      } else {
        content.innerHTML = `
      <div class="space-y-3 p-6">
        <a href="/api/v1/login" class="block w-full bg-blue-600 text-white text-center py-3 rounded-lg hover:bg-blue-700">
          Login
        </a>
        <a href="/api/v1/signup" class="block w-full bg-green-600 text-white text-center py-3 rounded-lg hover:bg-green-700">
          Signup
        </a>
        <div class="text-center text-sm text-gray-600 mt-4">or</div>
            <button type="button" id="googleBtn"
        class="flex justify-center items-center w-full border py-2 rounded-lg hover:bg-gray-50">
        <img src="https://www.google.com/favicon.ico" class="w-5 h-5 mr-2" alt="Google">
        Continue with Google
        </button>


        <button type="button" id="githubBtn"
            class="flex justify-center items-center w-full border py-2 rounded-lg hover:bg-gray-50 mt-2">
        <img src="https://github.githubassets.com/favicons/favicon.png" class="w-5 h-5 mr-2" alt="GitHub">
        Continue with GitHub
        </button>
        </div>`;

        document
          .getElementById("googleBtn")
          ?.addEventListener("click", () => {
            document.getElementById("oauthGoogle").click();
          });
        document
          .getElementById("githubBtn")
          ?.addEventListener("click", () => {
            document.getElementById("oauthGithub").click();
          });
      }
    }

    function logout() {
      localStorage.clear();
      closeDrawer();
      setTimeout(() => location.reload(), 300);
    }

    openBtn.onclick = openDrawer;
    closeBtn.onclick = closeDrawer;
    overlay.onclick = closeDrawer;

    document.addEventListener("DOMContentLoaded", async () => {
      if (localStorage.getItem("jwt")) {
        await checkAdminStatus();
      }
      renderDrawer();
    });

    const origFetch = window.fetch;
    window.fetch = function (...args) {
      const jwt = localStorage.getItem("jwt");
      if (jwt && args[1]) {
        args[1].headers = args[1].headers || {};
        args[1].headers["Authorization"] = `Bearer ${jwt}`;
      }
      return origFetch.apply(this, args);
    };
</script>

<button id="debug-btn">Check My Roles</button>

<pre
        id="debug-output"
        style="background: #111; color: #0f0; padding: 10px; margin-top: 10px"
></pre>

<script>
    document
      .getElementById("debug-btn")
      .addEventListener("click", async () => {
        const token = localStorage.getItem("jwt");

        if (!token) {
          document.getElementById("debug-output").textContent =
            "No JWT token found in localStorage.";
          return;
        }

        try {
          const response = await fetch("/api/v1/auth/debug", {
            method: "GET",
            headers: {
              Authorization: "Bearer " + token,
            },
          });

          const data = await response.json();

          document.getElementById("debug-output").textContent =
            JSON.stringify(data, null, 2);
        } catch (err) {
          document.getElementById("debug-output").textContent =
            "Request failed: " + err;
        }
      });
</script>
</body>
</html>
