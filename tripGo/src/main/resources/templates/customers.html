<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/api/v1/images/favicon.png">
    <title>Admin Panel - Customers | TripGo</title>
    <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");

        * {
          font-family: "Inter", sans-serif;
        }

        .gradient-bg {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
          transition: none;
        }

        .card-hover:hover {
          box-shadow: none;
        }

        .modal-enter {
          animation: modalEnter 0.3s ease-out;
        }

        @keyframes modalEnter {
          from {
            opacity: 0;
            transform: scale(0.95);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }

        .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          transition: none;
        }

        .btn-primary:hover {
          transform: none;
          box-shadow: none;
        }

        .stat-card {
          background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
        }

        .table-row {
          transition: none;
        }

        .table-row:hover {
          background-color: #f8f9ff;
          transform: none;
        }

        .badge {
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 600;
        }

        .input-modern {
          border: 2px solid #e5e7eb;
          transition: all 0.3s ease;
        }

        .input-modern:focus {
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
          outline: none;
        }

        /* Status Badges */
        .status-badge {
          padding: 4px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
        }

        .status-active {
          background-color: #d1fae5;
          color: #065f46;
        }

        .status-inactive {
          background-color: #f3f4f6;
          color: #6b7280;
        }

        /* Filter Panel */
        .filter-panel {
          transition: all 0.3s ease;
          max-height: 0;
          overflow: hidden;
        }

        .filter-panel.active {
          max-height: 500px;
          padding: 20px 0;
        }

        /* Loading Animation */
        .loading-spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* Customer Card */
        .customer-card {
          transition: all 0.3s ease;
        }

        .customer-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Role Badge */
        .role-badge {
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
        }

        .role-admin {
          background-color: #fef3c7;
          color: #92400e;
        }

        .role-customer {
          background-color: #dbeafe;
          color: #1e40af;
        }

        /* Avatar Styles */
        .avatar {
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          font-weight: 600;
          color: white;
        }

        .avatar-sm {
          width: 32px;
          height: 32px;
          font-size: 14px;
        }

        .avatar-md {
          width: 48px;
          height: 48px;
          font-size: 18px;
        }

        .avatar-lg {
          width: 64px;
          height: 64px;
          font-size: 24px;
        }

        /* Color variations for avatars */
        .avatar-purple { background-color: #8b5cf6; }
        .avatar-blue { background-color: #3b82f6; }
        .avatar-green { background-color: #10b981; }
        .avatar-yellow { background-color: #f59e0b; }
        .avatar-red { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
<!-- Sidebar -->
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 gradient-bg text-white hidden md:block">
        <div class="p-6">
            <div class="flex items-center space-x-3 ">
                <a href="/api/v1" class="flex items-center space-x-3 mb-8 w-[200px]">
                    <img src="/api/v1/images/logo.png" >
                </a>
            </div>

            <nav class="space-y-2">
                <a
                        href="/api/v1/admin1"
                        class="flex items-center space-x-3 hover:bg-white hover:bg-opacity-10 rounded-lg p-3 backdrop-blur-sm"
                >
                    <span class="text-xl">üìä</span>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a
                        href="/api/v1/bus"
                        class="flex items-center space-x-3 hover:bg-white hover:bg-opacity-10 rounded-lg p-3 transition"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 160 160" fill="none">
                        <!-- Bus icon -->
                        <path d="M79.9946 140C113.132 140 139.995 113.137 139.995 80C139.995 46.8629 113.132 20 79.9946 20C46.8575 20 19.9946 46.8629 19.9946 80C19.9946 113.137 46.8575 140 79.9946 140Z" fill="#FFE2CD"/>
                        <path d="M73.9846 129.14C78.1946 130.38 82.7246 130.19 86.9146 128.89L137.735 113.17C140.655 112.31 142.645 109.72 142.645 106.78V74.73C142.645 72.74 141.725 70.85 140.135 69.58L100.465 37.29C94.3346 32.4 77.9646 25.97 77.2946 33.6L65.4446 121.03C65.2046 123.78 68.0646 127.39 73.9746 129.14H73.9846Z" fill="white"/>
                        <path d="M74.9947 129.67L24.6547 124.49C20.1847 124.03 18.1547 120.76 17.5247 114.62V114.67C14.8147 74.25 23.4847 46.81 23.4847 46.81C24.5647 43.26 27.8847 40.73 31.3847 40.13L32.4947 39.95C45.8947 37.25 80.1047 30.13 80.1047 30.13C85.0347 29.28 89.5647 33.01 89.5647 37.93L83.8947 121.8C83.8947 126.5 79.7547 130.17 74.9947 129.68V129.67Z" fill="#C22126"/>
                        <path d="M76.4847 87.28L26.6148 87.19C22.4348 86.76 19.4147 83.05 19.9147 78.94L20.9648 71.22C22.0148 63.46 23.4748 55.75 25.3448 48.13L25.4048 47.87C26.3348 44.59 28.7147 42.4 31.9847 41.83L78.5147 32.25C83.1247 31.45 87.3547 34.94 87.3547 39.54L84.7947 79.9C84.7947 84.29 80.9248 87.72 76.4748 87.26L76.4847 87.28Z" fill="#551615"/>
                        <path d="M76.1926 110.556C76.4275 106.913 73.9596 103.788 70.6803 103.577C67.401 103.365 64.5522 106.147 64.3173 109.79C64.0823 113.433 66.5502 116.558 69.8295 116.769C73.1088 116.981 75.9576 114.199 76.1926 110.556Z" fill="#FC790D"/>
                        <mask id="mask0_9754_139" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="64" y="103" width="13" height="14">
                            <path d="M76.1926 110.556C76.4275 106.913 73.9596 103.788 70.6803 103.577C67.401 103.365 64.5522 106.147 64.3173 109.79C64.0823 113.433 66.5502 116.558 69.8295 116.769C73.1088 116.981 75.9576 114.199 76.1926 110.556Z" fill="white"/>
                        </mask>
                        <g mask="url(#mask0_9754_139)">
                            <path d="M80.2319 110.453C80.4255 106.913 77.8644 103.894 74.5115 103.711C71.1586 103.527 68.2836 106.249 68.09 109.789C67.8964 113.33 70.4576 116.348 73.8104 116.532C77.1633 116.715 80.0383 113.994 80.2319 110.453Z" fill="#FDFBF0"/>
                        </g>
                        <path d="M33.241 106.881C33.4493 103.651 31.2636 100.881 28.3591 100.694C25.4546 100.507 22.9311 102.973 22.7228 106.203C22.5146 109.432 24.7003 112.202 27.6048 112.39C30.5093 112.577 33.0327 110.111 33.241 106.881Z" fill="#FC790D"/>
                        <mask id="mask1_9754_139" style="mask-type:luminance" maskUnits="userSpaceOnUse" x="22" y="100" width="12" height="13">
                            <path d="M33.241 106.881C33.4493 103.651 31.2636 100.881 28.3591 100.694C25.4546 100.507 22.9311 102.973 22.7228 106.203C22.5146 109.432 24.7003 112.202 27.6048 112.39C30.5093 112.577 33.0327 110.111 33.241 106.881Z" fill="white"/>
                        </mask>
                        <g mask="url(#mask1_9754_139)">
                            <path d="M36.8156 106.804C36.9872 103.666 34.7167 100.991 31.7443 100.828C28.7719 100.666 26.2232 103.078 26.0517 106.216C25.8801 109.354 28.1506 112.029 31.1229 112.192C34.0953 112.354 36.644 109.942 36.8156 106.804Z" fill="#FDFBF0"/>
                        </g>
                    </svg>
                    <span class="font-medium">Buses</span>
                </a>
                <a
                        href="/api/v1/routes"
                        class="flex items-center space-x-3 hover:bg-white hover:bg-opacity-10 rounded-lg p-3 transition"
                >
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span class="font-medium">Routes</span>
                </a>
                <a href="/api/v1/schedule"
                   class="flex items-center space-x-3 hover:bg-white hover:bg-opacity-10  rounded-lg p-3 transition">
                    <span class="text-xl">üìÖ</span>
                    <span class="font-medium">Schedules</span>
                </a>
                <a
                        href="/api/v1/adminbooking"
                        class="flex items-center space-x-3 hover:bg-white hover:bg-opacity-10 rounded-lg p-3 transition"
                >
                    <span class="text-xl">üé´</span>
                    <span class="font-medium">Bookings</span>
                </a>
                <a
                        href="/api/v1/customers"
                        class="flex items-center space-x-3 bg-white bg-opacity-20 rounded-lg p-3 transition"
                >
                    <span class="text-xl">üë•</span>
                    <span class="font-medium">Customers</span>
                </a>
            </nav>

            <div class="absolute bottom-6 left-6 right-6 w-60">
                <div class="bg-white bg-opacity-20  backdrop-blur-sm rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div
                                class="w-10 h-10 bg-white rounded-full flex items-center justify-center" id="userLetter"
                        >
                        </div>
                        <div class="flex-1"  id="content">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="px-8 py-4 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Customer Management</h2>
                    <p class="text-gray-500 text-sm mt-1">
                        Manage your customers and their information
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input
                                type="search"
                                id="searchInput"
                                placeholder="Search customers..."
                                class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                oninput="searchCustomers()"
                        />
                        <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                    </div>
                    <button
                            onclick="toggleFilters()"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2"
                    >
                        <i class="fas fa-filter"></i>
                        <span>Filters</span>
                    </button>
                    <button
                            onclick="exportCustomers()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2"
                    >
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Filter Panel -->
        <div id="filterPanel" class="filter-panel bg-white border-b border-gray-200 px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Account Status
                    </label>
                    <select
                            id="statusFilter"
                            class="w-full p-2 input-modern rounded-lg"
                            onchange="applyFilters()"
                    >
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="INACTIVE">Inactive</option>
                    </select>
                </div>

                <!-- Registration Date -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Registered Since
                    </label>
                    <select
                            id="dateFilter"
                            class="w-full p-2 input-modern rounded-lg"
                            onchange="applyFilters()"
                    >
                        <option value="">All Time</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Sort By
                    </label>
                    <select
                            id="sortFilter"
                            class="w-full p-2 input-modern rounded-lg"
                            onchange="applyFilters()"
                    >
                        <option value="name_asc">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="recent">Most Recent</option>
                        <option value="oldest">Oldest</option>
                        <option value="bookings_desc">Most Bookings</option>
                        <option value="bookings_asc">Fewest Bookings</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button
                        onclick="clearFilters()"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                >
                    Clear All
                </button>
                <button
                        onclick="applyFilters()"
                        class="btn-primary text-white px-6 py-2 rounded-lg font-medium"
                >
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="px-8 py-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div
                        class="stat-card rounded-xl p-6 shadow-sm card-hover border border-gray-100"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Customers</p>
                            <p
                                    class="text-3xl font-bold text-gray-800 mt-2"
                                    id="totalCustomers"
                            >
                                0
                            </p>
                        </div>
                        <div
                                class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center"
                        >
                            <i class="fas fa-users text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-green-600 font-semibold" id="customerChange">0%</span>
                        <span class="text-gray-500 ml-2">from last month</span>
                    </div>
                </div>

                <div
                        class="stat-card rounded-xl p-6 shadow-sm card-hover border border-gray-100"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Active Customers</p>
                            <p
                                    class="text-3xl font-bold text-gray-800 mt-2"
                                    id="activeCustomers"
                            >
                                0
                            </p>
                        </div>
                        <div
                                class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"
                        >
                            <i class="fas fa-user-check text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-green-600 font-semibold" id="activeChange">0%</span>
                        <span class="text-gray-500 ml-2">currently active</span>
                    </div>
                </div>

                <div
                        class="stat-card rounded-xl p-6 shadow-sm card-hover border border-gray-100"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Bookings</p>
                            <p
                                    class="text-3xl font-bold text-gray-800 mt-2"
                                    id="totalBookingsCount"
                            >
                                0
                            </p>
                        </div>
                        <div
                                class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center"
                        >
                            <i class="fas fa-ticket-alt text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-blue-600 font-semibold" id="bookingsChange">0%</span>
                        <span class="text-gray-500 ml-2">average per customer</span>
                    </div>
                </div>

                <div
                        class="stat-card rounded-xl p-6 shadow-sm card-hover border border-gray-100"
                >
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Avg. Bookings</p>
                            <p
                                    class="text-3xl font-bold text-gray-800 mt-2"
                                    id="avgBookings"
                            >
                                0
                            </p>
                        </div>
                        <div
                                class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center"
                        >
                            <i class="fas fa-chart-bar text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span class="text-yellow-600 font-semibold" id="avgChange">0%</span>
                        <span class="text-gray-500 ml-2">from last month</span>
                    </div>
                </div>
            </div>

            <!-- Top Customers Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Top Customers by Bookings</h3>
                    <select
                            id="topCustomersPeriod"
                            class="p-2 border border-gray-300 rounded-lg"
                            onchange="loadTopCustomers()"
                    >
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="topCustomersList">
                    <!-- Filled by JS -->
                    <div class="col-span-full flex justify-center py-8">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Customers Table -->
            <div
                    class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
            >
                <div
                        class="px-6 py-4 border-b border-gray-200 flex justify-between items-center"
                >
                    <h3 class="text-lg font-bold text-gray-800">All Customers</h3>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600" id="paginationInfo">
                            Showing 0-0 of 0
                        </div>
                        <div class="flex space-x-2">
                            <button
                                    onclick="previousPage()"
                                    class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50"
                                    id="prevBtn"
                                    disabled
                            >
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button
                                    onclick="nextPage()"
                                    class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50"
                                    id="nextBtn"
                                    disabled
                            >
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Customer
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Contact Info
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Account
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Bookings
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                        </thead>
                        <tbody id="customersBody" class="bg-white divide-y divide-gray-200">
                        <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="p-8 text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading customers...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="p-12 text-center hidden">
                    <div class="w-24 h-24 mx-auto mb-4 text-gray-300">
                        <i class="fas fa-users text-6xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">No customers found</h3>
                    <p class="text-gray-500">Try adjusting your search or filters</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Customer Details Modal -->
<div
        id="customerDetailsModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"
>
    <div
            class="bg-white rounded-2xl p-8 w-full max-w-4xl max-h-screen overflow-y-auto modal-enter shadow-2xl"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Customer Details</h3>
            <button
                    onclick="closeModal('customerDetailsModal')"
                    class="text-gray-400 hover:text-gray-600 text-2xl"
            >
                √ó
            </button>
        </div>

        <div id="customerDetailsContent">
            <!-- Filled by JS -->
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div
        id="editCustomerModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"
>
    <div
            class="bg-white rounded-2xl p-8 w-full max-w-lg modal-enter shadow-2xl"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Edit Customer</h3>
            <button
                    onclick="closeModal('editCustomerModal')"
                    class="text-gray-400 hover:text-gray-600 text-2xl"
            >
                √ó
            </button>
        </div>

        <form id="editCustomerForm">
            <input type="hidden" id="editCustomerId" />

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Full Name
                    </label>
                    <input
                            type="text"
                            id="editName"
                            class="w-full p-3 input-modern rounded-lg"
                            required
                    />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Email Address
                    </label>
                    <input
                            type="email"
                            id="editEmail"
                            class="w-full p-3 input-modern rounded-lg"
                            required
                    />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Phone Number
                    </label>
                    <input
                            type="tel"
                            id="editPhone"
                            class="w-full p-3 input-modern rounded-lg"
                    />
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        User Roles
                    </label>
                    <div class="space-y-2" id="editRolesContainer">
                        <!-- Roles will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mt-8">
                <button
                        type="submit"
                        class="flex-1 btn-primary text-white px-6 py-3 rounded-lg font-semibold transition"
                >
                    Update Customer
                </button>
                <button
                        type="button"
                        onclick="closeModal('editCustomerModal')"
                        class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition"
                >
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div
        id="deleteCustomerModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"
>
    <div
            class="bg-white rounded-2xl p-8 w-full max-w-md modal-enter shadow-2xl"
    >
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Delete Customer</h3>
            <button
                    onclick="closeModal('deleteCustomerModal')"
                    class="text-gray-400 hover:text-gray-600 text-2xl"
            >
                √ó
            </button>
        </div>

        <div class="mb-8">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <p class="text-center text-gray-700 mb-4">
                Are you sure you want to delete this customer account?
            </p>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-sm text-red-800">
                    <strong>Warning:</strong> This action cannot be undone. All customer data, including booking history, will be permanently deleted.
                </p>
            </div>
        </div>

        <input type="hidden" id="deleteCustomerId" />

        <div class="flex space-x-3">
            <button
                    onclick="confirmDeleteCustomer()"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition"
            >
                Delete Customer
            </button>
            <button
                    onclick="closeModal('deleteCustomerModal')"
                    class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold transition"
            >
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="globalLoading" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 flex flex-col items-center">
        <div class="loading-spinner mb-4"></div>
        <p class="text-gray-700 font-medium">Processing...</p>
    </div>
</div>

<script>
    const jwt = localStorage.getItem("jwt");
    const username = localStorage.getItem("username") || "User";

    const content = document.getElementById("content");
    const firstLetter = document.getElementById("userLetter");

    if (jwt) {
        firstLetter.innerHTML = `
            <span class="text-purple-600 font-bold">${username.charAt(0).toUpperCase()}</span>
        `;

        content.innerHTML = `
            <p class="font-semibold text-sm">Admin User</p>
            <p class="font-medium text-sm">${username}</p>
        `;
    }

    // Global state
    let currentCustomers = [];
    let currentPage = 0;
    let totalPages = 0;
    let totalElements = 0;
    let pageSize = 10;
    let currentFilters = {};

    // Auth headers
    function getAuthHeaders() {
        return {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + jwt
        };
    }

    // Show/hide loading
    function showLoading(show) {
        document.getElementById("globalLoading").style.display = show ? "flex" : "none";
    }

    // Avatar colors for different initials
    const avatarColors = [
        'avatar-purple', 'avatar-blue', 'avatar-green', 'avatar-yellow', 'avatar-red'
    ];

    function getAvatarColor(name) {
        const firstChar = name.charAt(0).toUpperCase();
        const charCode = firstChar.charCodeAt(0);
        return avatarColors[charCode % avatarColors.length];
    }

    // Get initials for avatar
    function getInitials(name) {
        return name.split(' ')
            .map(word => word.charAt(0))
            .join('')
            .toUpperCase()
            .substring(0, 2);
    }

    // Load customers with pagination
    async function loadCustomers(page = 0, filters = {}) {
        try {
            document.getElementById("loadingState").classList.remove("hidden");
            document.getElementById("customersBody").innerHTML = "";
            document.getElementById("emptyState").classList.add("hidden");

            let url = `/api/v1/admin/customers?page=${page}&size=${pageSize}`;

            // Add filters to URL
            const params = new URLSearchParams();
            if (filters.search) params.append("search", filters.search);
            if (filters.status) params.append("status", filters.status);
            if (filters.sort) params.append("sort", filters.sort);

            const paramString = params.toString();
            if (paramString) {
                url += `&${paramString}`;
            }

            const response = await fetch(url, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error("Failed to load customers");

            const data = await response.json();

            document.getElementById("loadingState").classList.add("hidden");

            if (!data.content || data.content.length === 0) {
                document.getElementById("emptyState").classList.remove("hidden");
                currentCustomers = [];
                updatePagination(data);
                updateStatsCards(data);
                return;
            }

            currentCustomers = data.content;
            currentPage = data.number;
            totalPages = data.totalPages;
            totalElements = data.totalElements;

            renderCustomersTable();
            updatePagination(data);
            updateStatsCards(data);

        } catch (error) {
            console.error("Error loading customers:", error);
            document.getElementById("loadingState").classList.add("hidden");
            Swal.fire("Error", "Failed to load customers", "error");
        }
    }

    // Render customers table
    function renderCustomersTable() {
        const tbody = document.getElementById("customersBody");
        tbody.innerHTML = "";

        currentCustomers.forEach(customer => {
            const row = document.createElement("tr");
            row.className = "table-row hover:bg-gray-50";

            // Get avatar initials and color
            const initials = getInitials(customer.name);
            const avatarColor = getAvatarColor(customer.name);

            // Determine status
            const isActive = customer.user ? customer.user.enabled : true;
            const statusText = isActive ? "Active" : "Inactive";
            const statusClass = isActive ? "status-active" : "status-inactive";

            // Role badge
            const isAdmin = customer.user && customer.user.roles &&
                          customer.user.roles.some(role => role.name === "ROLE_ADMIN");
            const roleText = isAdmin ? "Admin" : "Customer";
            const roleClass = isAdmin ? "role-admin" : "role-customer";

            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="avatar avatar-md ${avatarColor} mr-3">
                            ${initials}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${customer.name}</div>
                            <div class="flex items-center mt-1">
                                <span class="${roleClass} role-badge mr-2">${roleText}</span>
                                <span class="text-xs text-gray-500">ID: ${customer.customerId}</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-800">${customer.email}</div>
                    <div class="text-sm text-gray-500">${customer.phone || 'No phone provided'}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-800">${customer.user ? customer.user.username : 'N/A'}</div>
                    <div class="text-xs text-gray-500">
                        ${customer.user ? 'Registered' : 'No account'}
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="font-semibold text-gray-800">${customer.totalBookings || 0}</div>
                    <div class="text-xs text-gray-500">bookings</div>
                </td>
                <td class="px-6 py-4">
                    <span class="${statusClass} status-badge">${statusText}</span>
                </td>
                <td class="px-6 py-4">
                    <div class="flex justify-center space-x-2">
                        <button
                            onclick="viewCustomerDetails(${customer.customerId})"
                            class="bg-blue-100 hover:bg-blue-200 text-blue-600 p-2 rounded-lg transition"
                            title="View Details"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button
                            onclick="editCustomer(${customer.customerId})"
                            class="bg-yellow-100 hover:bg-yellow-200 text-yellow-600 p-2 rounded-lg transition"
                            title="Edit Customer"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button
                            onclick="deleteCustomer(${customer.customerId})"
                            class="bg-red-100 hover:bg-red-200 text-red-600 p-2 rounded-lg transition"
                            title="Delete Customer"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    // Update pagination controls
    function updatePagination(data) {
        const start = (data.number * data.size) + 1;
        const end = Math.min((data.number + 1) * data.size, data.totalElements);

        document.getElementById("paginationInfo").textContent =
            `Showing ${start}-${end} of ${data.totalElements}`;

        document.getElementById("prevBtn").disabled = data.first;
        document.getElementById("nextBtn").disabled = data.last;
    }

    // Update stats cards
    function updateStatsCards(data) {
        // Calculate stats from data
        const totalCustomers = data.totalElements || 0;
        const activeCustomers = currentCustomers.filter(c =>
            c.user && c.user.enabled).length;
        const totalBookings = currentCustomers.reduce((sum, customer) =>
            sum + (customer.totalBookings || 0), 0);
        const avgBookings = totalCustomers > 0 ?
            (totalBookings / totalCustomers).toFixed(1) : 0;

        document.getElementById("totalCustomers").textContent = totalCustomers.toLocaleString();
        document.getElementById("activeCustomers").textContent = activeCustomers.toLocaleString();
        document.getElementById("totalBookingsCount").textContent = totalBookings.toLocaleString();
        document.getElementById("avgBookings").textContent = avgBookings;

        // TODO: Implement trend calculations
        document.getElementById("customerChange").textContent = "+8.2%";
        document.getElementById("activeChange").textContent = "+5.7%";
        document.getElementById("bookingsChange").textContent = "+12.3%";
        document.getElementById("avgChange").textContent = "+4.1%";
    }

    // Load top customers
    async function loadTopCustomers() {
        try {
            const period = document.getElementById("topCustomersPeriod").value;

            const response = await fetch(`/api/v1/admin/customers/top?period=${period}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error("Failed to load top customers");

            const topCustomers = await response.json();
            renderTopCustomers(topCustomers);
        } catch (error) {
            console.error("Error loading top customers:", error);

            const container = document.getElementById("topCustomersList");
            container.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <div class="text-yellow-600 mb-2">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <p class="text-gray-500">Unable to load top customers</p>
                    <button onclick="loadTopCustomers()" class="mt-2 text-blue-600 hover:text-blue-800 font-medium">
                        Retry
                    </button>
                </div>
            `;
        }
    }

    function renderTopCustomers(customers) {
        const container = document.getElementById("topCustomersList");
        container.innerHTML = "";

        if (!Array.isArray(customers) || customers.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <div class="text-gray-400 mb-2">
                        <i class="fas fa-users text-2xl"></i>
                    </div>
                    <p class="text-gray-500">No top customers found</p>
                </div>
            `;
            return;
        }

        // Only show top 4 customers
        const top4 = customers.slice(0, 4);

        top4.forEach(customer => {
            const initials = getInitials(customer.name);
            const avatarColor = getAvatarColor(customer.name);

            const card = document.createElement("div");
            card.className = "customer-card bg-white border border-gray-200 rounded-lg p-6 text-center";

            card.innerHTML = `
                <div class="avatar avatar-lg ${avatarColor} mx-auto mb-4">
                    ${initials}
                </div>
                <h4 class="font-bold text-gray-800 mb-1 truncate">${customer.name}</h4>
                <p class="text-sm text-gray-500 mb-2 truncate">${customer.email}</p>
                <div class="flex items-center justify-center mb-4">
                    <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
                        ${customer.totalBookings || 0} bookings
                    </div>
                </div>
                <div class="text-xs text-gray-500">
                    ${customer.totalRevenue ? `‚Çπ${customer.totalRevenue.toLocaleString('en-IN')} spent` : 'No spending data'}
                </div>
            `;

            container.appendChild(card);
        });

        // Add "View All" link if there are more customers
        if (customers.length > 4) {
            const viewAll = document.createElement("div");
            viewAll.className = "col-span-full text-center mt-4";
            viewAll.innerHTML = `
                <button
                    onclick="loadAllTopCustomers()"
                    class="text-blue-600 hover:text-blue-800 font-medium"
                >
                    View all ${customers.length} top customers
                </button>
            `;
            container.appendChild(viewAll);
        }
    }

    // View customer details
    async function viewCustomerDetails(customerId) {
        try {
            showLoading(true);

            const response = await fetch(`/api/v1/admin/customers/${customerId}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error("Failed to load customer details");

            const customer = await response.json();
            showLoading(false);

            renderCustomerDetails(customer);
            document.getElementById("customerDetailsModal").classList.remove("hidden");
        } catch (error) {
            showLoading(false);
            console.error("Error loading customer details:", error);
            Swal.fire("Error", "Failed to load customer details", "error");
        }
    }

    function renderCustomerDetails(customer) {
        const content = document.getElementById("customerDetailsContent");

        const initials = getInitials(customer.name);
        const avatarColor = getAvatarColor(customer.name);
        const isActive = customer.user ? customer.user.enabled : true;
        const statusText = isActive ? "Active" : "Inactive";
        const statusClass = isActive ? "status-active" : "status-inactive";

        content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Customer Profile -->
                <div class="col-span-1">
                    <div class="bg-gray-50 rounded-lg p-6 text-center">
                        <div class="avatar avatar-lg ${avatarColor} mx-auto mb-4">
                            ${initials}
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${customer.name}</h3>
                        <span class="${statusClass} status-badge">${statusText}</span>
                    </div>
                </div>

                <!-- Contact Info -->
                <div class="col-span-2">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Contact Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-600 mb-1">Email Address</div>
                                <div class="font-medium text-gray-800">${customer.email}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">Phone Number</div>
                                <div class="font-medium text-gray-800">${customer.phone || 'Not provided'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">Username</div>
                                <div class="font-medium text-gray-800">${customer.user ? customer.user.username : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">Customer ID</div>
                                <div class="font-medium text-gray-800">${customer.customerId}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Statistics -->
            <div class="bg-gray-50 rounded-lg p-6 mb-8">
                <h4 class="text-lg font-bold text-gray-800 mb-4">Booking Statistics</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-800">${customer.totalBookings || 0}</div>
                        <div class="text-sm text-gray-600">Total Bookings</div>
                    </div>
                    <div class="text-center">
            <div class="text-2xl font-bold text-green-600">‚Çπ${customer.totalRevenue || 0}</div>
            <div class="text-sm text-gray-600">Total Revenue</div>
        </div>
        <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">${customer.averageBookingValue ? `‚Çπ${customer.averageBookingValue.toFixed(2)}` : '‚Çπ0'}</div>
            <div class="text-sm text-gray-600">Avg. Booking Value</div>
        </div>
        <div class="text-center">
            <div class="text-2xl font-bold text-yellow-600">${customer.lastBooking ? new Date(customer.lastBooking).toLocaleDateString() : 'Never'}</div>
            <div class="text-sm text-gray-600">Last Booking</div>
        </div>
                </div>
            </div>

            <!-- Recent Bookings -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="text-lg font-bold text-gray-800 mb-4">Recent Bookings</h4>
                ${customer.recentBookings && customer.recentBookings.length > 0 ?
                    `<div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Booking ID</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Date</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Bus</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Amount</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customer.recentBookings.map(booking => `
                                    <tr class="border-b border-gray-200">
                                        <td class="px-4 py-3 text-sm font-medium text-gray-800">${booking.bookingId}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${new Date(booking.bookingDate).toLocaleDateString()}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${booking.busNumber || 'N/A'}</td>
                                        <td class="px-4 py-3 text-sm text-green-600 font-medium">‚Çπ${booking.totalAmount || 0}</td>
                                        <td class="px-4 py-3">
                                            <span class="${booking.status === 'CONFIRMED' ? 'status-confirmed' : 'status-cancelled'} status-badge">
                                                ${booking.status}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>` :
                    `<div class="text-center py-8">
                        <div class="text-gray-400 mb-2">
                            <i class="fas fa-ticket-alt text-2xl"></i>
                        </div>
                        <p class="text-gray-500">No recent bookings found</p>
                    </div>`
                }
            </div>
        `;
    }

    // Role data structure - match backend enum values
const availableRoles = [
    { id: 'CUSTOMER', name: 'Customer', description: 'Regular customer account' },
    { id: 'ADMIN', name: 'Admin', description: 'Administrator account' },
    // Add more roles as they exist in your backend
];

// Function to map frontend role IDs to backend enum values
function mapRoleToBackend(roleId) {
    // Remove "ROLE_" prefix if it exists
    if (roleId.startsWith('ROLE_')) {
        return roleId.substring(5); // Removes "ROLE_" prefix
    }
    return roleId;
}


// Function to map backend role to frontend display
function mapRoleToFrontend(role) {
    // Check if role is an object with properties or just a string
    if (typeof role === 'object' && role !== null) {
        // If it's an object, check for different property names
        if (role.name) return role.name;
        if (role.authority) return role.authority;
        if (role.role) return role.role;
        return JSON.stringify(role);
    }

    // If it's a string
    const roleStr = String(role);
    if (roleStr.startsWith('ROLE_')) {
        return roleStr;
    }
    return 'ROLE_' + roleStr.toUpperCase();
}


// Update renderRoleCheckboxes function
function renderRoleCheckboxes(selectedRoles = []) {
    const container = document.getElementById("editRolesContainer");
    container.innerHTML = "";

    availableRoles.forEach(role => {
        // Check if role is selected
        let isSelected = false;

        if (Array.isArray(selectedRoles)) {
            isSelected = selectedRoles.some(selectedRole => {
                // Handle both object and string roles
                const selectedRoleValue = typeof selectedRole === 'object' ?
                    selectedRole.name || selectedRole.authority :
                    selectedRole;

                // Remove ROLE_ prefix for comparison
                const backendRole = mapRoleToBackend(selectedRoleValue);
                return backendRole === role.id;
            });
        }

        const roleDiv = document.createElement("div");
        roleDiv.className = "flex items-start space-x-3 p-3 bg-gray-50 rounded-lg";

        roleDiv.innerHTML = `
            <div class="flex items-center h-6">
                <input
                    type="checkbox"
                    id="role-${role.id}"
                    value="${role.id}"
                    ${isSelected ? 'checked' : ''}
                    class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                />
            </div>
            <div class="flex-1">
                <label for="role-${role.id}" class="font-medium text-gray-700 cursor-pointer">
                    ${role.name}
                </label>
                <p class="text-sm text-gray-500 mt-1">${role.description}</p>
            </div>
        `;

        container.appendChild(roleDiv);
    });
}

    // Edit customer
    async function editCustomer(customerId) {
    try {
        showLoading(true);

        const response = await fetch(`/api/v1/admin/customers/${customerId}`, {
            headers: getAuthHeaders()
        });

        if (!response.ok) throw new Error("Failed to load customer for editing");

        const customer = await response.json();
        showLoading(false);

        document.getElementById("editCustomerId").value = customer.customerId;
        document.getElementById("editName").value = customer.name;
        document.getElementById("editEmail").value = customer.email;
        document.getElementById("editPhone").value = customer.phone || '';


        // Render roles
        const selectedRoles = customer.user ? customer.user.roles : [];
        renderRoleCheckboxes(selectedRoles);

        document.getElementById("editCustomerModal").classList.remove("hidden");
    } catch (error) {
        showLoading(false);
        console.error("Error loading customer for editing:", error);
        Swal.fire("Error", "Failed to load customer for editing", "error");
    }
}


    // Update form submission to send correct enum values
document.getElementById("editCustomerForm").onsubmit = async (e) => {
    e.preventDefault();

    const customerId = document.getElementById("editCustomerId").value;

    // Get selected roles as backend enum values
    const selectedRoles = Array.from(
        document.querySelectorAll('#editRolesContainer input[type="checkbox"]:checked')
    ).map(checkbox => checkbox.value.toUpperCase()); // Ensure uppercase

    const updatedData = {
        name: document.getElementById("editName").value,
        email: document.getElementById("editEmail").value,
        phone: document.getElementById("editPhone").value,
        roles: selectedRoles // This will be ["ADMIN"] or ["CUSTOMER"]
    };

    console.log("Sending update data:", updatedData); // Debug log

    try {
        showLoading(true);

        const response = await fetch(`/api/v1/admin/customers/${customerId}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify(updatedData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to update customer: ${response.status} - ${errorText}`);
        }

        showLoading(false);
        closeModal('editCustomerModal');

        Swal.fire({
            icon: 'success',
            title: 'Customer Updated',
            text: 'Customer information has been successfully updated.',
            showConfirmButton: false,
            timer: 1500
        });

        // Reload customers
        loadCustomers(currentPage, currentFilters);

    } catch (error) {
        showLoading(false);
        console.error("Error updating customer:", error);
        Swal.fire("Error", error.message, "error");
    }
};

    // Delete customer confirmation
    function deleteCustomer(customerId) {
        document.getElementById("deleteCustomerId").value = customerId;
        document.getElementById("deleteCustomerModal").classList.remove("hidden");
    }

    // Confirm delete customer
    async function confirmDeleteCustomer() {
        const customerId = document.getElementById("deleteCustomerId").value;

        try {
            showLoading(true);

            const response = await fetch(`/api/v1/admin/customers/${customerId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error("Failed to delete customer");

            showLoading(false);
            closeModal('deleteCustomerModal');

            Swal.fire({
                icon: 'success',
                title: 'Customer Deleted',
                text: 'Customer account has been successfully deleted.',
                showConfirmButton: false,
                timer: 1500
            });

            // Reload customers
            loadCustomers(currentPage, currentFilters);

        } catch (error) {
            showLoading(false);
            console.error("Error deleting customer:", error);
            Swal.fire("Error", "Failed to delete customer", "error");
        }
    }

    // Filter functions
    function toggleFilters() {
        const panel = document.getElementById("filterPanel");
        panel.classList.toggle("active");
    }

    function searchCustomers() {
        const searchTerm = document.getElementById("searchInput").value.trim();
        if (searchTerm !== currentFilters.search) {
            currentFilters.search = searchTerm;
            loadCustomers(0, currentFilters);
        }
    }

    function applyFilters() {
        const filters = {
            status: document.getElementById("statusFilter").value,
            dateFilter: document.getElementById("dateFilter").value,
            sort: document.getElementById("sortFilter").value,
            search: document.getElementById("searchInput").value.trim()
        };

        currentFilters = filters;
        loadCustomers(0, filters);

        // Close filter panel if open
        document.getElementById("filterPanel").classList.remove("active");
    }

    function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("dateFilter").value = "";
        document.getElementById("sortFilter").value = "name_asc";

        currentFilters = {};
        loadCustomers(0, {});
    }

    // Pagination functions
    function previousPage() {
        if (currentPage > 0) {
            loadCustomers(currentPage - 1, currentFilters);
        }
    }

    function nextPage() {
        if (currentPage < totalPages - 1) {
            loadCustomers(currentPage + 1, currentFilters);
        }
    }

    // Export customers
    async function exportCustomers() {
        try {
            showLoading(true);

            const response = await fetch('/api/v1/admin/customers/export', {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error("Failed to export customers");

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showLoading(false);

        } catch (error) {
            showLoading(false);
            console.error("Error exporting customers:", error);
            Swal.fire("Error", "Failed to export customers", "error");
        }
    }

    // Load all top customers
    function loadAllTopCustomers() {
        // This could open a modal with the full list
        // For now, just load more data
        document.getElementById('topCustomersPeriod').value = 'all';
        loadTopCustomers();
    }

    // Modal functions
    function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
    }

    // Initialize
    async function init() {
        if (!jwt) {
            window.location.href = '/api/v1/login';
            return;
        }

        await loadCustomers();
        await loadTopCustomers();
    }

    // Start the application
    init();
</script>
</body>
</html>